# ============================================
# LUXETHREAD - DOCKER COMPOSE
# Full production stack orchestration
# ============================================

version: '3.8'

services:
  # ==========================================
  # MongoDB Database
  # ==========================================
  mongo:
    image: mongo:7.0
    container_name: luxethread-mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-changeme}
      MONGO_INITDB_DATABASE: luxethread
    volumes:
      - mongo_data:/data/db
      - mongo_config:/data/configdb
    networks:
      - luxethread-network
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ==========================================
  # Backend API Server
  # ==========================================
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: luxethread-server
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=${SERVER_PORT:-5000}
      - MONGO_URI=mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-changeme}@mongo:27017/luxethread?authSource=admin
      - JWT_SECRET=${JWT_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_PORT=${EMAIL_PORT}
      - EMAIL_USER=${EMAIL_USER}
      - EMAIL_PASS=${EMAIL_PASS}
      - EMAIL_FROM=${EMAIL_FROM}
      - CLIENT_URL=${CLIENT_URL:-http://localhost}
    volumes:
      - server_uploads:/app/uploads
    networks:
      - luxethread-network
    depends_on:
      mongo:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================
  # Frontend React App (Nginx)
  # ==========================================
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-http://localhost/api}
    container_name: luxethread-client
    restart: unless-stopped
    ports:
      - "${CLIENT_PORT:-80}:80"
    networks:
      - luxethread-network
    depends_on:
      server:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

# ==========================================
# Networks
# ==========================================
networks:
  luxethread-network:
    driver: bridge

# ==========================================
# Volumes (Persistent Data)
# ==========================================
volumes:
  mongo_data:
    driver: local
  mongo_config:
    driver: local
  server_uploads:
    driver: local
